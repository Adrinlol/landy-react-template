import e from"postcss-value-parser";import t from"path";import{parse as r}from"postcss";import{promises as o}from"fs";function s(e){const t=e.selector?e:e.parent;return/(!\s*)?postcss-custom-properties:\s*off\b/i.test(t.toString())}function n(t,r){const o=new Map,n=new Map,i=new Map;t.nodes.slice().forEach((t=>{const i=c(t)?o:p(t)?n:null;i&&(t.nodes.slice().forEach((t=>{if(t.variable&&!s(t)){const{prop:o}=t;i.set(o,e(t.value)),r.preserve||t.remove()}})),r.preserve||!l(t)||s(t)||t.remove())}));for(const[e,t]of o.entries())i.set(e,t);for(const[e,t]of n.entries())i.set(e,t);return i}const i=/^html$/i,a=/^:root$/i,c=e=>"rule"===e.type&&e.selector.split(",").some((e=>i.test(e)))&&Object(e.nodes).length,p=e=>"rule"===e.type&&e.selector.split(",").some((e=>a.test(e)))&&Object(e.nodes).length,l=e=>0===Object(e.nodes).length;function u(t){const r=new Map;if("customProperties"in t)for(const[o,s]of Object.entries(t.customProperties))r.set(o,e(s.toString()));if("custom-properties"in t)for(const[o,s]of Object.entries(t["custom-properties"]))r.set(o,e(s.toString()));return r}async function f(e){return u(await import(e))}async function m(e){const s=(await Promise.all(e.map((async e=>{if(e instanceof Promise?e=await e:e instanceof Function&&(e=await e()),"string"==typeof e){const r=t.resolve(e);return{type:t.extname(r).slice(1).toLowerCase(),from:r}}if("customProperties"in e&&Object(e.customProperties)===e.customProperties)return e;if("custom-properties"in e&&Object(e["custom-properties"])===e["custom-properties"])return e;if("from"in e){const r=t.resolve(e.from);let o=e.type;return o||(o=t.extname(r).slice(1).toLowerCase()),{type:o,from:r}}return Object.keys(e).length,null})))).filter((e=>!!e)),i=await Promise.all(s.map((async e=>{if("type"in e&&"from"in e){if("css"===e.type||"pcss"===e.type)return await async function(e){const t=await o.readFile(e);return n(r(t,{from:e.toString()}),{preserve:!0})}(e.from);if("js"===e.type||"cjs"===e.type)return await f(e.from);if("mjs"===e.type)return await f(e.from);if("json"===e.type)return await async function(e){return u(await w(e))}(e.from);throw new Error("Invalid source type: "+e.type)}return u(e)}))),a=new Map;return i.forEach((e=>{for(const[t,r]of e.entries())a.set(t,r)})),a}const w=async e=>JSON.parse((await o.readFile(e)).toString());function v(e,t){return e.nodes&&e.nodes.length&&e.nodes.slice().forEach((r=>{if(d(r)){const[o,...s]=r.nodes.filter((e=>"div"!==e.type)),{value:n}=o,i=e.nodes.indexOf(r);if(t.has(n)){const r=t.get(n).nodes;!function(e,t,r){const o=new Map(t);o.delete(r),v(e,o)}({nodes:r},t,n),i>-1&&e.nodes.splice(i,1,...r)}else s.length&&(i>-1&&e.nodes.splice(i,1,...s),v(e,t))}else v(r,t)})),e.toString()}const y=/^var$/i,d=e=>"function"===e.type&&y.test(e.value)&&Object(e.nodes).length>0;var j=(t,r,o)=>{if($(t)&&!function(e){const t=e.prev();return Boolean(s(e)||t&&"comment"===t.type&&/(!\s*)?postcss-custom-properties:\s*ignore\s+next\b/i.test(t.text))}(t)){const s=t.value;let n=v(e(s),r);const i=new Set;for(;g.test(n)&&!i.has(n);){i.add(n);n=v(e(n),r)}if(n!==s)if(o.preserve){const e=t.cloneBefore({value:n});h(e)&&(e.raws.value.value=e.value.replace(b,"$1"),e.raws.value.raw=e.raws.value.value+e.raws.value.raw.replace(b,"$2"))}else t.value=n,h(t)&&(t.raws.value.value=t.value.replace(b,"$1"),t.raws.value.raw=t.raws.value.value+t.raws.value.raw.replace(b,"$2"))}};const O=/^--[A-z][\w-]*$/,g=/(^|[^\w-])var\([\W\w]+\)/,$=e=>!O.test(e.prop)&&g.test(e.value),h=e=>"value"in Object(Object(e.raws).value)&&"raw"in e.raws.value&&b.test(e.raws.value.raw),b=/^([\W\w]+)(\s*\/\*[\W\w]+?\*\/)$/;async function x(e,t,r){"css"===t&&await async function(e,t){const r=`:root {\n${Object.keys(t).reduce(((e,r)=>(e.push(`\t${r}: ${t[r]};`),e)),[]).join("\n")}\n}\n`;await o.writeFile(e,r)}(e,r),"scss"===t&&await async function(e,t){const r=`${Object.keys(t).reduce(((e,r)=>{const o=r.replace("--","$");return e.push(`${o}: ${t[r]};`),e}),[]).join("\n")}\n`;await o.writeFile(e,r)}(e,r),"js"===t&&await async function(e,t){const r=`module.exports = {\n\tcustomProperties: {\n${Object.keys(t).reduce(((e,r)=>(e.push(`\t\t'${P(r)}': '${P(t[r])}'`),e)),[]).join(",\n")}\n\t}\n};\n`;await o.writeFile(e,r)}(e,r),"json"===t&&await async function(e,t){const r=`${JSON.stringify({"custom-properties":t},null,"  ")}\n`;await o.writeFile(e,r)}(e,r),"mjs"===t&&await async function(e,t){const r=`export const customProperties = {\n${Object.keys(t).reduce(((e,r)=>(e.push(`\t'${P(r)}': '${P(t[r])}'`),e)),[]).join(",\n")}\n};\n`;await o.writeFile(e,r)}(e,r)}function F(e){const t={};for(const[r,o]of e.entries())t[r]=o.toString();return t}const P=e=>e.replace(/\\([\s\S])|(')/g,"\\$1$2").replace(/\n/g,"\\n").replace(/\r/g,"\\r"),S=e=>{const r=!("preserve"in Object(e))||Boolean(e.preserve),o="overrideImportFromWithRoot"in Object(e)&&Boolean(e.overrideImportFromWithRoot);let s=[];Array.isArray(null==e?void 0:e.importFrom)?s=e.importFrom:null!=e&&e.importFrom&&(s=[e.importFrom]);let i=[];Array.isArray(null==e?void 0:e.exportTo)?i=e.exportTo:null!=e&&e.exportTo&&(i=[e.exportTo]);const a=m(s);let c=new Map;const p=0===s.length&&0===i.length;return{postcssPlugin:"postcss-custom-properties",prepare:()=>p?{Once:e=>{c=n(e,{preserve:r})},Declaration:e=>{j(e,c,{preserve:r})},OnceExit:()=>{c.clear()}}:{Once:async e=>{const s=(await a).entries(),p=n(e,{preserve:r}).entries();if(o)for(const[e,t]of[...s,...p])c.set(e,t);else for(const[e,t]of[...p,...s])c.set(e,t);await function(e,r){return Promise.all(r.map((async r=>{if(r instanceof Function)return void await r(F(e));if("string"==typeof r){const o=t.resolve(r),s=t.extname(o).slice(1).toLowerCase();return void await x(o,s,F(e))}let o={};if(o="toJSON"in r?r.toJSON(F(e)):F(e),"to"in r){const e=t.resolve(r.to);let s=r.type;return s||(s=t.extname(e).slice(1).toLowerCase()),void await x(e,s,o)}"customProperties"in r?r.customProperties=o:"custom-properties"in r&&(r["custom-properties"]=o)})))}(c,i)},Declaration:e=>{j(e,c,{preserve:r})},OnceExit:()=>{c.clear()}}}};S.postcss=!0;export{S as default};
